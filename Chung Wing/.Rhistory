forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6)
anova(forestmodel6, type = 2)
#deciding which model to keep
forestmodel7 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8 <- lmer(D_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel)
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
6.137e-04/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by random family effect factor: 33.95%
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10)
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11)
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
anova(RTDmodel, type = 2)
summary(RTDmodel)
4.278e-05/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by site blocking factor: 0.81%
2.345e-04/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by random family effect factor: 4.42%
#SRL
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#D
D_emmeans <- emmeans(forestmodel8, ~Mycorrhizaltype)
D_emmeans <- as.data.frame(D_emmeans)
D_emmeans$emmean <- exp(D_emmeans$emmean)
D_emmeans$lower.CL <- exp(D_emmeans$lower.CL)
D_emmeans$upper.CL <- exp(D_emmeans$upper.CL)
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = D_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = D_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = D, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "D (mm)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#RTD
RTD_emmeans <- emmeans(RTDmodel, ~Mycorrhizaltype)
RTD_emmeans <- as.data.frame(RTD_emmeans)
RTD_emmeans$emmean <- exp(RTD_emmeans$emmean)
RTD_emmeans$lower.CL <- exp(RTD_emmeans$lower.CL)
RTD_emmeans$upper.CL <- exp(RTD_emmeans$upper.CL)
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = RTD_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = RTD_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = RTD, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "RTD (g/cm^3)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#dataset summary stats
summary(forestdata)
View(RTD_c)
summary(forestdata$SRL)
#dataset summary stats
summary(forestdata)
SRL_emmeans
SRL_emmeans
forestmodel1 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel1)
anova(forestmodel1, type = 2)
#deciding which model to keep
forestmodel2 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel3 <- lmer(SRL ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel2, forestmodel3, refit = FALSE) #drop interaction term
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel)
anova(SRLmodel, type = 2)
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5)
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6)
anova(forestmodel6, type = 2)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel)
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10)
mcp.fnc(forestmodel10) #normality assumption not great
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11)
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
summary(RTDmodel)
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
SRL_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#3D plot
forestdata %>% plot_ly(x = ~SRL, y = ~RTD,
z = ~D, color = ~Mycorrhizaltype, colors = c("#0072B2", "#009E73"), symbol = ~Foresttype,
symbols = c("circle", "x", "square"), type = "scatter3d",
mode = "markers") %>% layout(title = "Root traits by Mycorrhizal type and Forest type",
scene = list(xaxis = list(title = "Specific root length (cm/g)"),
yaxis = list(title = "Root tissue density (g/cm^3)"),
zaxis = list(title = "Average root diameter (mm)")))
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = D_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = D_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = D, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "D (mm)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = RTD_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = RTD_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = RTD, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "RTD (g/cm^3)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
anova(forestmodel3, forestmodel3_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel) #assumptions okay
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
#loading libraries
library("readxl") #read file
library("ggplot2") #plotting
library("plotly") #plotting 3D
library("Rmisc") #summary stats
library("dplyr") #tidying dataset
library("tidyverse") #manipulate dataset
library("lme4") #mixed models
library("lmerTest") #p values
library("LMERConvenienceFunctions") #diagnostic plots
library("emmeans") #model predicted values
#import data
mycorrhizae <- read_excel("/Users/chungwingko/Documents/NTU/Fall 2021/ES7028/R stuff/data/mycorrhizae.xlsx")
#view data
str(mycorrhizae)
#change to factors
mycorrhizae$Site <- as.factor(mycorrhizae$Site)
mycorrhizae$Foresttype <- as.factor(mycorrhizae$`Forest type`)
mycorrhizae$Mycorrhizaltype <- as.factor(mycorrhizae$`Mycorrhizal type`)
mycorrhizae$Family <- as.factor(mycorrhizae$Family)
#rename columns
mycorrhizae$SRL <- mycorrhizae$`SRL (cm/g)`
mycorrhizae$RTD <- mycorrhizae$`RTD (g/cm^3)`
mycorrhizae$D <- mycorrhizae$`D (mm)`
#reorder group factor levels
mycorrhizae$Foresttype <- factor(mycorrhizae$Foresttype, levels=c('Old growth', 'Naturally regenerating', 'Restored secondary'))
#take subset
forestdata <- subset(mycorrhizae, select = c(Site, Foresttype, Mycorrhizaltype, Family, SRL, RTD, D))
#dataset summary stats
summary(forestdata)
#3D plot
forestdata %>% plot_ly(x = ~SRL, y = ~RTD,
z = ~D, color = ~Mycorrhizaltype, colors = c("#0072B2", "#009E73"), symbol = ~Foresttype,
symbols = c("circle", "x", "square"), type = "scatter3d",
mode = "markers") %>% layout(title = "Root traits by Mycorrhizal type and Forest type",
scene = list(xaxis = list(title = "Specific root length (cm/g)"),
yaxis = list(title = "Root tissue density (g/cm^3)"),
zaxis = list(title = "Average root diameter (mm)")))
#summary stats
SRL_c <- summarySE(forestdata, measurevar="SRL", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
D_c <- summarySE(forestdata, measurevar="D", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
RTD_c <- summarySE(forestdata, measurevar="RTD", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
#graph mean and SE
ggplot(SRL_c, aes(Mycorrhizaltype, SRL, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=SRL-se, ymax=SRL+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Specific Root Length (cm/g)") + ggtitle("Specific Root Length by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(D_c, aes(Mycorrhizaltype, D, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=D-se, ymax=D+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Average Root Diameter (mm)") + ggtitle("Average Root Diameter by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(RTD_c, aes(Mycorrhizaltype, RTD, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=RTD-se, ymax=RTD+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Root Tissue Density (g/cm^3)") + ggtitle("Root Tissue Density by Mycorrhizal Type and Forest Type") + theme_bw()
forestmodel1 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel1) #assumptions met
anova(forestmodel1, type = 2)
#deciding which model to keep
forestmodel2 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel3 <- lmer(SRL ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel2, forestmodel3, refit = FALSE) #drop interaction term
forestmodel3_1 <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel3, forestmodel3_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel) #assumptions okay
anova(SRLmodel, type = 2)
summary(SRLmodel)
4578/(4578 + 14501) #variance explained by family random effect: 23.99%
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5) #normality assumption not great
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6) #normality assumption better
anova(forestmodel6, type = 2)
#deciding which model to keep
forestmodel7 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8 <- lmer(D_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
6.137e-04/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by random family effect factor: 33.95%
mcp.fnc(forestmodel5) #normality assumption not great
mcp.fnc(forestmodel6) #normality assumption better
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10) #normality assumption not great
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11) #..better
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
anova(RTDmodel, type = 2) #assumptions not great but okay
summary(RTDmodel)
4.278e-05/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by site blocking factor: 0.81%
2.345e-04/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by random family effect factor: 4.42%
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
SRL_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mychorrhizaltype/Family), data = forestdata, REML = TRUE)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
#loading libraries
library("readxl") #read file
library("ggplot2") #plotting
library("plotly") #plotting 3D
library("Rmisc") #summary stats
library("dplyr") #tidying dataset
library("tidyverse") #manipulate dataset
library("lme4") #mixed models
library("lmerTest") #p values
library("LMERConvenienceFunctions") #diagnostic plots
library("emmeans") #model predicted values
#import data
mycorrhizae <- read_excel("/Users/chungwingko/Documents/NTU/Fall 2021/ES7028/R stuff/data/mycorrhizae.xlsx")
#view data
str(mycorrhizae)
#change to factors
mycorrhizae$Site <- as.factor(mycorrhizae$Site)
mycorrhizae$Foresttype <- as.factor(mycorrhizae$`Forest type`)
mycorrhizae$Mycorrhizaltype <- as.factor(mycorrhizae$`Mycorrhizal type`)
mycorrhizae$Family <- as.factor(mycorrhizae$Family)
#rename columns
mycorrhizae$SRL <- mycorrhizae$`SRL (cm/g)`
mycorrhizae$RTD <- mycorrhizae$`RTD (g/cm^3)`
mycorrhizae$D <- mycorrhizae$`D (mm)`
#reorder group factor levels
mycorrhizae$Foresttype <- factor(mycorrhizae$Foresttype, levels=c('Old growth', 'Naturally regenerating', 'Restored secondary'))
#take subset
forestdata <- subset(mycorrhizae, select = c(Site, Foresttype, Mycorrhizaltype, Family, SRL, RTD, D))
#dataset summary stats
summary(forestdata)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
#loading libraries
library("readxl") #read file
library("ggplot2") #plotting
library("plotly") #plotting 3D
library("Rmisc") #summary stats
library("dplyr") #tidying dataset
library("tidyverse") #manipulate dataset
library("lme4") #mixed models
library("lmerTest") #p values
library("LMERConvenienceFunctions") #diagnostic plots
library("emmeans") #model predicted values
#import data
mycorrhizae <- read_excel("/Users/chungwingko/Documents/NTU/Fall 2021/ES7028/R stuff/data/mycorrhizae.xlsx")
#view data
str(mycorrhizae)
#change to factors
mycorrhizae$Site <- as.factor(mycorrhizae$Site)
mycorrhizae$Foresttype <- as.factor(mycorrhizae$`Forest type`)
mycorrhizae$Mycorrhizaltype <- as.factor(mycorrhizae$`Mycorrhizal type`)
mycorrhizae$Family <- as.factor(mycorrhizae$Family)
#rename columns
mycorrhizae$SRL <- mycorrhizae$`SRL (cm/g)`
mycorrhizae$RTD <- mycorrhizae$`RTD (g/cm^3)`
mycorrhizae$D <- mycorrhizae$`D (mm)`
#reorder group factor levels
mycorrhizae$Foresttype <- factor(mycorrhizae$Foresttype, levels=c('Old growth', 'Naturally regenerating', 'Restored secondary'))
#take subset
forestdata <- subset(mycorrhizae, select = c(Site, Foresttype, Mycorrhizaltype, Family, SRL, RTD, D))
#dataset summary stats
summary(forestdata)
#3D plot
forestdata %>% plot_ly(x = ~SRL, y = ~RTD,
z = ~D, color = ~Mycorrhizaltype, colors = c("#0072B2", "#009E73"), symbol = ~Foresttype,
symbols = c("circle", "x", "square"), type = "scatter3d",
mode = "markers") %>% layout(title = "Root traits by Mycorrhizal type and Forest type",
scene = list(xaxis = list(title = "Specific root length (cm/g)"),
yaxis = list(title = "Root tissue density (g/cm^3)"),
zaxis = list(title = "Average root diameter (mm)")))
#summary stats
SRL_c <- summarySE(forestdata, measurevar="SRL", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
D_c <- summarySE(forestdata, measurevar="D", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
RTD_c <- summarySE(forestdata, measurevar="RTD", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
#graph mean and SE
ggplot(SRL_c, aes(Mycorrhizaltype, SRL, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=SRL-se, ymax=SRL+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Specific Root Length (cm/g)") + ggtitle("Specific Root Length by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(D_c, aes(Mycorrhizaltype, D, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=D-se, ymax=D+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Average Root Diameter (mm)") + ggtitle("Average Root Diameter by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(RTD_c, aes(Mycorrhizaltype, RTD, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=RTD-se, ymax=RTD+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Root Tissue Density (g/cm^3)") + ggtitle("Root Tissue Density by Mycorrhizal Type and Forest Type") + theme_bw()
forestmodel1 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel1) #assumptions met
anova(forestmodel1, type = 2)
#deciding which model to keep
forestmodel2 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel3 <- lmer(SRL ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel2, forestmodel3, refit = FALSE) #drop interaction term
forestmodel3_1 <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel3, forestmodel3_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel) #assumptions okay
anova(SRLmodel, type = 2)
summary(SRLmodel)
4578/(4578 + 14501) #variance explained by family random effect: 23.99%
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5) #normality assumption not great
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6) #normality assumption better
anova(forestmodel6, type = 2)
#deciding which model to keep
forestmodel7 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8 <- lmer(D_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
6.137e-04/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by random family effect factor: 33.95%
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10) #normality assumption not great
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11) #..better
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
anova(RTDmodel, type = 2) #assumptions not great but okay
summary(RTDmodel)
4.278e-05/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by site blocking factor: 0.81%
2.345e-04/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by random family effect factor: 4.42%
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
SRL_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
D_emmeans <- emmeans(forestmodel8, ~Mycorrhizaltype)
D_emmeans <- as.data.frame(D_emmeans)
D_emmeans$emmean <- exp(D_emmeans$emmean)
D_emmeans$lower.CL <- exp(D_emmeans$lower.CL)
D_emmeans$upper.CL <- exp(D_emmeans$upper.CL)
D_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = D_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = D_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = D, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "D (mm)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
RTD_emmeans <- emmeans(RTDmodel, ~Mycorrhizaltype)
RTD_emmeans <- as.data.frame(RTD_emmeans)
RTD_emmeans$emmean <- exp(RTD_emmeans$emmean)
RTD_emmeans$lower.CL <- exp(RTD_emmeans$lower.CL)
RTD_emmeans$upper.CL <- exp(RTD_emmeans$upper.CL)
RTD_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = RTD_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = RTD_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = RTD, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "RTD (g/cm^3)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
anova(Dmodel, type = 2)
summary(Dmodel)
20 %% 8
setwd("~/Documents/NTU/Spring 2022/ISS- Spatial Analysis in R/ISS_RSpatial/Chung Wing")
#load data
load(url("https://github.com/mgimond/Spatial/raw/main/Data/moransI.RData"))
#map income distribution
library(tmap)
tm_shape(s1) + tm_polygons(style="quantile", col = "Income") +
tm_legend(outside = TRUE, text.size = .8)
#define neighboring polygons
library(spdep)
nb <- poly2nb(s1, queen=TRUE)
#lists neighboring polygons
nb[[1]]
#extracting name of polygon 1
s1$NAME[1]
s1$NAME[c(2,3,4,5)]
#assigning weights to polygons
lw <- nb2listw(nb, style="W", zero.policy=TRUE)
#compute spatially lagged values (average neighbor income value for each polygon)
Inc.lag <- lag.listw(lw, s1$Income)
#method 1 (hard way)
M <- lm(Inc.lag ~ s1$Income) #create a regression model of lagged income vs income
plot( Inc.lag ~ s1$Income, pch=20, asp=1, las=1) #plot data
coef(M)[2] #slope of line is Moran's I coefficient
#compute a pseudo p-value from this simulation
N.greater <- sum(coef(M)[2] > I.r) #find # simulated values > observed value
p <- min(N.greater + 1, n + 1 - N.greater) / (n + 1) #compute one sided p
p
hist(I.r, main=NULL, xlab="Moran's I", las=1) #plot the histogram of simulated Moran's I values
abline(v=coef(M)[2], col="red") #then add our observed Moran's I value to the plot
#compute a pseudo p-value from this simulation
N.greater <- sum(coef(M)[2] > I.r) #find # simulated values > observed value
# Spatial autocorrelation
#load data
load(url("https://github.com/mgimond/Spatial/raw/main/Data/moransI.RData"))
#map income distribution
library(tmap)
tm_shape(s1) + tm_polygons(style="quantile", col = "Income") +
tm_legend(outside = TRUE, text.size = .8)
#define neighboring polygons
library(spdep)
nb <- poly2nb(s1, queen=TRUE) #queen = true means shared vertex (otherwise, shared edge)
#lists neighboring polygons
nb[[1]]
#extracting name of polygon 1
s1$NAME[1]
s1$NAME[c(2,3,4,5)] #extracting other county names
#assigning weights to polygons
lw <- nb2listw(nb, style="W", zero.policy=TRUE)
#here we use equal weight with (1/# neighbors)
#drawback is that edge polygons have fewer neighbors so may change estimates
#zero.policy=TRUE option allows for lists of non-neighbors, use with caution
#see weights of first polygon's neighbors
lw$weights[1]
#compute spatially lagged values (average neighbor income value for each polygon)
Inc.lag <- lag.listw(lw, s1$Income)
#computing Moran's I statistic
#method 1 (hard way)
M <- lm(Inc.lag ~ s1$Income) #create a regression model of lagged income vs income
plot( Inc.lag ~ s1$Income, pch=20, asp=1, las=1) #plot data
coef(M)[2] #slope of line is Moran's I coefficient
#assess if slope is significantly different from zero (null hypothesis)
n <- 599L   #define the number of simulations
I.r <- vector(length=n)  #create an empty vector
for (i in 1:n){
#randomly shuffle income values
x <- sample(s1$Income, replace=FALSE)
#compute new set of lagged values
x.lag <- lag.listw(lw, x)
#compute the regression slope and store its value
M.r    <- lm(x.lag ~ x)
I.r[i] <- coef(M.r)[2]
}
hist(I.r, main=NULL, xlab="Moran's I", las=1) #plot the histogram of simulated Moran's I values
abline(v=coef(M)[2], col="red") #then add our observed Moran's I value to the plot
#suggests this is different from null
#compute a pseudo p-value from this simulation
N.greater <- sum(coef(M)[2] > I.r) #find # simulated values > observed value
p <- min(N.greater + 1, n + 1 - N.greater) / (n + 1) #compute one sided p
p
#method 2 for Moran's I statistic (easy way)
moran.test(s1$Income,lw)
#simulate instead
MC<- moran.mc(s1$Income, lw, nsim=599)
MC #view results (including p value)
#plot the distribution (note that this is a density plot instead of a histogram)
plot(MC, main="", las=1)
#defining neighbors with distance bands instead of polygons
coo <- coordinates(s1) #extract center of each polygon
lw <- nb2listw(S.dist, style="W",zero.policy=T) #ID all neighboring polygons for each polygon
#defining neighbors with distance bands instead of polygons
coo <- coordinates(s1) #extract center of each polygon
S.dist  <-  dnearneigh(coo, 0, 50000) #define search radius for centers within given distance (0,50000 are inner and outer radiuses)
lw <- nb2listw(S.dist, style="W",zero.policy=T) #ID all neighboring polygons for each polygon
#run MC simulation
MI  <-  moran.mc(s1$Income, lw, nsim=599,zero.policy=T)
plot(MI, main="", las=1) #plot
#defining neighbors with distance bands instead of polygons
#can study range of autocorrelation values as function of distance
#would look at how Moran's I values changes over distance
coo <- coordinates(s1) #extract center of each polygon
S.dist  <-  dnearneigh(coo, 0, 50000) #define search radius for centers within given distance (0,50000 are inner and outer radiuses)
lw <- nb2listw(S.dist, style="W",zero.policy=T) #ID all neighboring polygons for each polygon
#run MC simulation
MI  <-  moran.mc(s1$Income, lw, nsim=599,zero.policy=T)
plot(MI, main="", las=1) #plot
MI #display p value and summary stats
