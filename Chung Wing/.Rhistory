summary(SRLmodel)
4578/(4578 + 14501) #variance explained by family random effect: 23.99%
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5)
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6)
anova(forestmodel6, type = 2)
#deciding which model to keep
forestmodel7 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8 <- lmer(D_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel)
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
6.137e-04/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by random family effect factor: 33.95%
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10)
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11)
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
anova(RTDmodel, type = 2)
summary(RTDmodel)
4.278e-05/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by site blocking factor: 0.81%
2.345e-04/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by random family effect factor: 4.42%
#SRL
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#D
D_emmeans <- emmeans(forestmodel8, ~Mycorrhizaltype)
D_emmeans <- as.data.frame(D_emmeans)
D_emmeans$emmean <- exp(D_emmeans$emmean)
D_emmeans$lower.CL <- exp(D_emmeans$lower.CL)
D_emmeans$upper.CL <- exp(D_emmeans$upper.CL)
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = D_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = D_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = D, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "D (mm)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#RTD
RTD_emmeans <- emmeans(RTDmodel, ~Mycorrhizaltype)
RTD_emmeans <- as.data.frame(RTD_emmeans)
RTD_emmeans$emmean <- exp(RTD_emmeans$emmean)
RTD_emmeans$lower.CL <- exp(RTD_emmeans$lower.CL)
RTD_emmeans$upper.CL <- exp(RTD_emmeans$upper.CL)
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = RTD_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = RTD_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = RTD, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "RTD (g/cm^3)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#dataset summary stats
summary(forestdata)
View(RTD_c)
summary(forestdata$SRL)
#dataset summary stats
summary(forestdata)
SRL_emmeans
SRL_emmeans
forestmodel1 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel1)
anova(forestmodel1, type = 2)
#deciding which model to keep
forestmodel2 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel3 <- lmer(SRL ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel2, forestmodel3, refit = FALSE) #drop interaction term
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel)
anova(SRLmodel, type = 2)
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5)
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6)
anova(forestmodel6, type = 2)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel)
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10)
mcp.fnc(forestmodel10) #normality assumption not great
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11)
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
summary(RTDmodel)
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
SRL_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#3D plot
forestdata %>% plot_ly(x = ~SRL, y = ~RTD,
z = ~D, color = ~Mycorrhizaltype, colors = c("#0072B2", "#009E73"), symbol = ~Foresttype,
symbols = c("circle", "x", "square"), type = "scatter3d",
mode = "markers") %>% layout(title = "Root traits by Mycorrhizal type and Forest type",
scene = list(xaxis = list(title = "Specific root length (cm/g)"),
yaxis = list(title = "Root tissue density (g/cm^3)"),
zaxis = list(title = "Average root diameter (mm)")))
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = D_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = D_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = D, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "D (mm)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = RTD_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = RTD_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = RTD, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "RTD (g/cm^3)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
anova(forestmodel3, forestmodel3_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel) #assumptions okay
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
#loading libraries
library("readxl") #read file
library("ggplot2") #plotting
library("plotly") #plotting 3D
library("Rmisc") #summary stats
library("dplyr") #tidying dataset
library("tidyverse") #manipulate dataset
library("lme4") #mixed models
library("lmerTest") #p values
library("LMERConvenienceFunctions") #diagnostic plots
library("emmeans") #model predicted values
#import data
mycorrhizae <- read_excel("/Users/chungwingko/Documents/NTU/Fall 2021/ES7028/R stuff/data/mycorrhizae.xlsx")
#view data
str(mycorrhizae)
#change to factors
mycorrhizae$Site <- as.factor(mycorrhizae$Site)
mycorrhizae$Foresttype <- as.factor(mycorrhizae$`Forest type`)
mycorrhizae$Mycorrhizaltype <- as.factor(mycorrhizae$`Mycorrhizal type`)
mycorrhizae$Family <- as.factor(mycorrhizae$Family)
#rename columns
mycorrhizae$SRL <- mycorrhizae$`SRL (cm/g)`
mycorrhizae$RTD <- mycorrhizae$`RTD (g/cm^3)`
mycorrhizae$D <- mycorrhizae$`D (mm)`
#reorder group factor levels
mycorrhizae$Foresttype <- factor(mycorrhizae$Foresttype, levels=c('Old growth', 'Naturally regenerating', 'Restored secondary'))
#take subset
forestdata <- subset(mycorrhizae, select = c(Site, Foresttype, Mycorrhizaltype, Family, SRL, RTD, D))
#dataset summary stats
summary(forestdata)
#3D plot
forestdata %>% plot_ly(x = ~SRL, y = ~RTD,
z = ~D, color = ~Mycorrhizaltype, colors = c("#0072B2", "#009E73"), symbol = ~Foresttype,
symbols = c("circle", "x", "square"), type = "scatter3d",
mode = "markers") %>% layout(title = "Root traits by Mycorrhizal type and Forest type",
scene = list(xaxis = list(title = "Specific root length (cm/g)"),
yaxis = list(title = "Root tissue density (g/cm^3)"),
zaxis = list(title = "Average root diameter (mm)")))
#summary stats
SRL_c <- summarySE(forestdata, measurevar="SRL", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
D_c <- summarySE(forestdata, measurevar="D", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
RTD_c <- summarySE(forestdata, measurevar="RTD", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
#graph mean and SE
ggplot(SRL_c, aes(Mycorrhizaltype, SRL, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=SRL-se, ymax=SRL+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Specific Root Length (cm/g)") + ggtitle("Specific Root Length by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(D_c, aes(Mycorrhizaltype, D, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=D-se, ymax=D+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Average Root Diameter (mm)") + ggtitle("Average Root Diameter by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(RTD_c, aes(Mycorrhizaltype, RTD, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=RTD-se, ymax=RTD+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Root Tissue Density (g/cm^3)") + ggtitle("Root Tissue Density by Mycorrhizal Type and Forest Type") + theme_bw()
forestmodel1 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel1) #assumptions met
anova(forestmodel1, type = 2)
#deciding which model to keep
forestmodel2 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel3 <- lmer(SRL ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel2, forestmodel3, refit = FALSE) #drop interaction term
forestmodel3_1 <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel3, forestmodel3_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel) #assumptions okay
anova(SRLmodel, type = 2)
summary(SRLmodel)
4578/(4578 + 14501) #variance explained by family random effect: 23.99%
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5) #normality assumption not great
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6) #normality assumption better
anova(forestmodel6, type = 2)
#deciding which model to keep
forestmodel7 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8 <- lmer(D_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
6.137e-04/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by random family effect factor: 33.95%
mcp.fnc(forestmodel5) #normality assumption not great
mcp.fnc(forestmodel6) #normality assumption better
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10) #normality assumption not great
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11) #..better
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
anova(RTDmodel, type = 2) #assumptions not great but okay
summary(RTDmodel)
4.278e-05/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by site blocking factor: 0.81%
2.345e-04/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by random family effect factor: 4.42%
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
SRL_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mychorrhizaltype/Family), data = forestdata, REML = TRUE)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
#loading libraries
library("readxl") #read file
library("ggplot2") #plotting
library("plotly") #plotting 3D
library("Rmisc") #summary stats
library("dplyr") #tidying dataset
library("tidyverse") #manipulate dataset
library("lme4") #mixed models
library("lmerTest") #p values
library("LMERConvenienceFunctions") #diagnostic plots
library("emmeans") #model predicted values
#import data
mycorrhizae <- read_excel("/Users/chungwingko/Documents/NTU/Fall 2021/ES7028/R stuff/data/mycorrhizae.xlsx")
#view data
str(mycorrhizae)
#change to factors
mycorrhizae$Site <- as.factor(mycorrhizae$Site)
mycorrhizae$Foresttype <- as.factor(mycorrhizae$`Forest type`)
mycorrhizae$Mycorrhizaltype <- as.factor(mycorrhizae$`Mycorrhizal type`)
mycorrhizae$Family <- as.factor(mycorrhizae$Family)
#rename columns
mycorrhizae$SRL <- mycorrhizae$`SRL (cm/g)`
mycorrhizae$RTD <- mycorrhizae$`RTD (g/cm^3)`
mycorrhizae$D <- mycorrhizae$`D (mm)`
#reorder group factor levels
mycorrhizae$Foresttype <- factor(mycorrhizae$Foresttype, levels=c('Old growth', 'Naturally regenerating', 'Restored secondary'))
#take subset
forestdata <- subset(mycorrhizae, select = c(Site, Foresttype, Mycorrhizaltype, Family, SRL, RTD, D))
#dataset summary stats
summary(forestdata)
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
#loading libraries
library("readxl") #read file
library("ggplot2") #plotting
library("plotly") #plotting 3D
library("Rmisc") #summary stats
library("dplyr") #tidying dataset
library("tidyverse") #manipulate dataset
library("lme4") #mixed models
library("lmerTest") #p values
library("LMERConvenienceFunctions") #diagnostic plots
library("emmeans") #model predicted values
#import data
mycorrhizae <- read_excel("/Users/chungwingko/Documents/NTU/Fall 2021/ES7028/R stuff/data/mycorrhizae.xlsx")
#view data
str(mycorrhizae)
#change to factors
mycorrhizae$Site <- as.factor(mycorrhizae$Site)
mycorrhizae$Foresttype <- as.factor(mycorrhizae$`Forest type`)
mycorrhizae$Mycorrhizaltype <- as.factor(mycorrhizae$`Mycorrhizal type`)
mycorrhizae$Family <- as.factor(mycorrhizae$Family)
#rename columns
mycorrhizae$SRL <- mycorrhizae$`SRL (cm/g)`
mycorrhizae$RTD <- mycorrhizae$`RTD (g/cm^3)`
mycorrhizae$D <- mycorrhizae$`D (mm)`
#reorder group factor levels
mycorrhizae$Foresttype <- factor(mycorrhizae$Foresttype, levels=c('Old growth', 'Naturally regenerating', 'Restored secondary'))
#take subset
forestdata <- subset(mycorrhizae, select = c(Site, Foresttype, Mycorrhizaltype, Family, SRL, RTD, D))
#dataset summary stats
summary(forestdata)
#3D plot
forestdata %>% plot_ly(x = ~SRL, y = ~RTD,
z = ~D, color = ~Mycorrhizaltype, colors = c("#0072B2", "#009E73"), symbol = ~Foresttype,
symbols = c("circle", "x", "square"), type = "scatter3d",
mode = "markers") %>% layout(title = "Root traits by Mycorrhizal type and Forest type",
scene = list(xaxis = list(title = "Specific root length (cm/g)"),
yaxis = list(title = "Root tissue density (g/cm^3)"),
zaxis = list(title = "Average root diameter (mm)")))
#summary stats
SRL_c <- summarySE(forestdata, measurevar="SRL", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
D_c <- summarySE(forestdata, measurevar="D", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
RTD_c <- summarySE(forestdata, measurevar="RTD", groupvars=c("Mycorrhizaltype", "Foresttype", "Family"))
#graph mean and SE
ggplot(SRL_c, aes(Mycorrhizaltype, SRL, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=SRL-se, ymax=SRL+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Specific Root Length (cm/g)") + ggtitle("Specific Root Length by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(D_c, aes(Mycorrhizaltype, D, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=D-se, ymax=D+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Average Root Diameter (mm)") + ggtitle("Average Root Diameter by Mycorrhizal Type and Forest Type") + theme_bw()
ggplot(RTD_c, aes(Mycorrhizaltype, RTD, color = Family)) + geom_point(aes(color = Family), stat = "identity", position=position_dodge(0.5)) + facet_wrap(~Foresttype) + geom_errorbar(aes(ymin=RTD-se, ymax=RTD+se), width=.5, position=position_dodge(0.5)) + xlab("Mycorrhizal Type") + ylab("Root Tissue Density (g/cm^3)") + ggtitle("Root Tissue Density by Mycorrhizal Type and Forest Type") + theme_bw()
forestmodel1 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel1) #assumptions met
anova(forestmodel1, type = 2)
#deciding which model to keep
forestmodel2 <- lmer(SRL ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel3 <- lmer(SRL ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel2, forestmodel3, refit = FALSE) #drop interaction term
forestmodel3_1 <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel3, forestmodel3_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
SRLmodel <- lmer(SRL ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(SRLmodel) #assumptions okay
anova(SRLmodel, type = 2)
summary(SRLmodel)
4578/(4578 + 14501) #variance explained by family random effect: 23.99%
#D
forestmodel5 <- lmer(D ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel5) #normality assumption not great
forestdata$D_trans <- log(forestdata$D)
forestmodel6 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel6) #normality assumption better
anova(forestmodel6, type = 2)
#deciding which model to keep
forestmodel7 <- lmer(D_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel8 <- lmer(D_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel7, forestmodel8, refit = FALSE) #drop interaction term
forestmodel8_1 <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel8, forestmodel8_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
anova(Dmodel, type = 2)
summary(Dmodel)
5.205e-06/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by site blocking factor: 0.29%
6.137e-04/(5.205e-06 + 6.137e-04 + 1.189e-03) #variance explained by random family effect factor: 33.95%
#RTD
forestmodel10 <- lmer(RTD ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel10) #normality assumption not great
forestdata$RTD_trans <- log(forestdata$RTD)
forestmodel11 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata)
mcp.fnc(forestmodel11) #..better
anova(forestmodel11, type = 2)
#deciding which model to keep
forestmodel12 <- lmer(RTD_trans ~ Foresttype*Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
forestmodel13 <- lmer(RTD_trans ~ Foresttype+Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel12, forestmodel13, refit = FALSE) #drop interaction term
forestmodel13_1 <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = FALSE)
anova(forestmodel13, forestmodel13_1, refit = FALSE) #drop non-significant forest fixed effect
#final model
RTDmodel <- lmer(RTD_trans ~ Mycorrhizaltype + (1|Site) + (1|Family), data = forestdata, REML = TRUE)
mcp.fnc(RTDmodel)
anova(RTDmodel, type = 2) #assumptions not great but okay
summary(RTDmodel)
4.278e-05/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by site blocking factor: 0.81%
2.345e-04/(4.278e-05 + 2.345e-04 + 5.027e-03) #variance explained by random family effect factor: 4.42%
SRL_emmeans <- emmeans(SRLmodel, ~Mycorrhizaltype)
SRL_emmeans <- as.data.frame(SRL_emmeans)
SRL_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = SRL_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = SRL_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = SRL, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "SRL (cm/g)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
D_emmeans <- emmeans(forestmodel8, ~Mycorrhizaltype)
D_emmeans <- as.data.frame(D_emmeans)
D_emmeans$emmean <- exp(D_emmeans$emmean)
D_emmeans$lower.CL <- exp(D_emmeans$lower.CL)
D_emmeans$upper.CL <- exp(D_emmeans$upper.CL)
D_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = D_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = D_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = D, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "D (mm)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
RTD_emmeans <- emmeans(RTDmodel, ~Mycorrhizaltype)
RTD_emmeans <- as.data.frame(RTD_emmeans)
RTD_emmeans$emmean <- exp(RTD_emmeans$emmean)
RTD_emmeans$lower.CL <- exp(RTD_emmeans$lower.CL)
RTD_emmeans$upper.CL <- exp(RTD_emmeans$upper.CL)
RTD_emmeans
ggplot() + geom_point(aes(x = Mycorrhizaltype, y = emmean, color = Mycorrhizaltype), position = position_dodge(width = 0.5), size = 3, data = RTD_emmeans) + geom_errorbar(aes(x = Mycorrhizaltype, ymin = lower.CL, ymax = upper.CL, color = Mycorrhizaltype), width = 0.2, size = 1, position = position_dodge(width = 0.5), data = RTD_emmeans) + geom_point(aes(x = Mycorrhizaltype, y = RTD, color = Mycorrhizaltype), position = position_nudge(x = -0.2, y = 0), data = forestdata) + labs(x = "Mycorrhizal Type", y = "RTD (g/cm^3)") + scale_color_manual(values = c("#0072B2", "#009E73")) + theme_bw() + theme(legend.position = "none")
#final model
Dmodel <- lmer(D_trans ~ Mycorrhizaltype + (1|Site) + (1|Mycorrhizaltype/Family), data = forestdata, REML = TRUE)
mcp.fnc(Dmodel) #assumptions met
anova(Dmodel, type = 2)
summary(Dmodel)
20 %% 8
setwd("~/Documents/NTU/Spring 2022/ISS- Spatial Analysis in R/ISS_RSpatial/Chung Wing")
setwd("~/Documents/NTU/Spring 2022/ISS- Spatial Analysis in R/ISS_RSpatial/Chung Wing")
install.packages(‘sdm’)
install.packages(sdm)
install.packages("sdm")
installAll()
library(sdm)
installAll()
library(sdm)
installAll()
#species distribution models have three steps: data prep, model fitting, prediction
# sdmData to read data and prep data object
# sdm to fit and evaluate species distribution models
# predict after model is fitted
# ensemble to predict given new dataset and combine into final projection
#read in data (a sf object and four raster datasets)
library(raster)
library(rgdal)
file <- system.file("external/species.shp", package="sdm") # get the location of the species shapefile
# so, file is simply a filename (with path):
file
# read the species shapefile using the function shapefile:
species <- shapefile(file)
class(species) # it is a SpatialPointsDataFrame
#read in data (a sf object and four raster datasets)
library(raster)
#plot
plot(species)
# we can take a look at the head of attribute table in the species dataset:
head(species)
#we can plot presence and absence points separately with different colours:
plot(species[species$Occurrence == 1,],col='blue',pch=16)
points(species[species$Occurrence == 0,],col='red',pch=16)
path <- system.file("external", package="sdm") # path to the folder contains the data
# list the name of files in the specified path, match the pattern # (means all files with a name ending to asc).
# We asked to generate full names (i.e., names with the path)
lst <- list.files(path=path,pattern='asc$',full.names = T)
lst # this is the name of raster files we want to use as predictor variables
lst # this is the name of raster files we want to use as predictor variables
# stack is a function in the raster package, to read/create a multi-layers raster dataset
preds <- stack(lst) # making a raster object
# stack is a function in the raster package, to read/create a multi-layers raster dataset
preds <- stack(lst) # making a raster object
preds # see the specification of the raster layers (e.g., cell size, extent, etc.)
plot(preds)
plot(preds[[4]]) # only plot the 4th layer
plot(species,add=T) # let's add the species point on the previous plot
#now that data is read, can use sdm pkg
#putting data in package that creates a data object
d <- sdmData(formula=Occurrence~., train=species, predictors=preds)
d
# we didn't really need the formula in this example, as it would be easy for the function to guess which
# dataset is species, and which are predictors. So, it could be like this:
d <- sdmData(train=species, predictors=preds)
d
# You may also want to take part of variables:
d <- sdmData(formula=Occurrence~precipitation+temperature, train=species,
predictors=preds)
d
d <- sdmData(formula= ~., train=species, predictors=preds)
#now can fit the models (specify variables/features through formula)
# in the following example, we use 3 different methods to fit the models.
m1 <- sdm(Occurrence~.,data=d,methods=c('glm','gam','brt'))
m1
# Here we are going to fit 5 models and evaluate them through 2 runs of subsampling, each draw 30 percent
# of training data as test dataset:
m2 <- sdm(Occurrence~.,data=d,methods=c('rf','tree','fda','mars','svm'),replicatin='sub',
test.percent=30,n=2)
m2
getModelInfo(m2) # info on runs including modelID, whether they are successfully fitted and evaluated, etc.
# We can generate the roc curve and compare the results for all models:
roc(m2)
# the plots can be smoothes:
roc(m2,smooth=T)
p1 <- predict(m1,newdata=preds,filename='p1.img')
plot(p1)
p2 <- predict(m2,newdata=preds,filename='p2.img')
p2
nlayers(p2)
plot(p2[[1:4]]) # plot the first 12 rasters
# we can take the mean of raster over different runs for each method and species:
p2m <- predict(m2,newdata=preds,filename='p2m.img',mean=T)
p2m
plot(p2m)
# full names of rasters:
getZ(p2m)
# ensemble based on a Weighted averaging that is weighted using AUC statistic
e1 <- ensemble(m1,newdata=preds,filename='e1.img',setting=list(method='weighted',stat='AUC'))
plot(e1)
# ensemble based on a Weighted averaging that is weighted using TSS statistic
# with threshold criterion number 2 which is max(Sensitivity+Specificity) or max(TSS)
e2 <- ensemble(m2,newdata=preds,filename='e2.img',
setting=list(method='weighted',stat='TSS',opt=2))
plot(e2)
# ensemble based on an Unweighted averaging
e3 <- ensemble(m2,newdata=preds,filename='e3.img',setting=list(method='unweighted'))
plot(e3)
# m2 was the output of sdm function in the above examples, then can use gui to explore everything inside m2:
gui(m2)
# We can generate the roc curve and compare the results for all models:
roc(m2)
